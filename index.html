<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ğŸ¥¤ å¿«æ¨‚æ°´ç´€éŒ„è¡¨ </title>
    
    <!-- PWA & Mobile Settings (iOS Support) -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="å¿«æ¨‚æ°´ç´€éŒ„">
    <!-- App Icon (Boba Icon) -->
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3081/3081162.png">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js (Added error handling in JS if this fails to load) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Google Fonts: Zen Maru Gothic (å¯æ„›åœ“é«”) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700&display=swap" rel="stylesheet">

    <!-- Web App Manifest -->
    <link rel="manifest" href='data:application/manifest+json;base64,eyJuYW1lIjoi5b+r5qiC5rC057SA6YyE6KGoIiwic2hvcnRfbmFtZSI6IuW/q+aoguawtCIsInN0YXJ0X3VybCI6Ii4iLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsImJhY2tncm91bmRfY29sb3IiOiIjRkZGQkYwIiwidGhlbWVfY29sb3IiOiIjRkZGQkYwIiwiaWNvbnMiOlt7InNyYyI6Imh0dHBzOi8vY2RuLWljb25zLXBuZy5mbGF0aWNvbi5jb20vNTEyLzMwODEvMzA4MTE2Mi5wbmciLCJzaXplcyI6IjUxMng1MTIiLCJ0eXBlIjoiaW1hZ2UvcG5nIn1dfQ=='>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Zen Maru Gothic"', 'sans-serif'],
                    },
                    colors: {
                        milk: '#FFFBF0',
                        tea: '#E6C9A8',
                        boba: '#5C4033',
                        matcha: '#C8D5B9',
                        berry: '#F4ACB7',
                        sky: '#D7E3FC'
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #FFFBF0; 
            overscroll-behavior-y: none;
        }
        
        /* Safe Area for iPhone X+ */
        .safe-area-padding {
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
        }

        .card {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #FFFBF0; 
        }
        ::-webkit-scrollbar-thumb {
            background: #E6C9A8; 
            border-radius: 10px;
        }
        /* Modal Animation */
        .modal {
            transition: opacity 0.3s ease-in-out;
        }
        .modal-content {
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .modal.hidden {
            opacity: 0;
            pointer-events: none;
        }
        .modal.hidden .modal-content {
            transform: scale(0.95) translateY(10px);
        }
    </style>
</head>
<body class="text-gray-700 antialiased min-h-screen flex flex-col items-center p-4 md:p-8 safe-area-padding pb-12">

    <!-- Header -->
    <header class="text-center mb-8 w-full max-w-5xl pt-4">
        <h1 class="text-3xl md:text-4xl font-bold text-boba mb-2">ğŸ¥¤ å¿«æ¨‚æ°´ç´€éŒ„è¡¨ </h1>
        <p class="text-gray-500">è¨˜éŒ„æ¯ä¸€æ»´å¿«æ¨‚ï¼Œçµ±è¨ˆæ¯ä¸€åˆ†èŠ±è²»ï¼</p>
    </header>

    <div class="w-full max-w-5xl grid grid-cols-1 lg:grid-cols-3 gap-6 flex-1">

        <!-- Left Column: Statistics & Input (Takes up 1 col on LG) -->
        <div class="lg:col-span-1 space-y-6">
            
            <!-- Key Stats Cards -->
            <div class="grid grid-cols-2 gap-4">
                <!-- Total Cups -->
                <div class="card bg-white p-4 rounded-3xl shadow-sm border border-tea text-center">
                    <div class="text-2xl mb-1">ğŸ§‹</div>
                    <div class="text-xs text-gray-400 font-bold uppercase tracking-wider">å¹´åº¦æ¯æ•¸</div>
                    <div class="text-2xl font-bold text-boba" id="stat-total-cups">0</div>
                </div>
                <!-- Total Spent -->
                <div class="card bg-white p-4 rounded-3xl shadow-sm border border-tea text-center">
                    <div class="text-2xl mb-1">ğŸ’°</div>
                    <div class="text-xs text-gray-400 font-bold uppercase tracking-wider">å¹´åº¦æ”¯å‡º</div>
                    <div class="text-2xl font-bold text-boba" id="stat-total-spent">$0</div>
                </div>
                <!-- Top Shop -->
                <div class="card bg-white p-4 rounded-3xl shadow-sm border border-matcha text-center col-span-2">
                    <div class="flex items-center justify-center space-x-2">
                        <span class="text-xl">ğŸ†</span>
                        <div class="text-left">
                            <div class="text-xs text-gray-400 font-bold uppercase">æœ€æ„›åº—å®¶</div>
                            <div class="text-lg font-bold text-gray-800 truncate w-32 md:w-48" id="stat-top-shop">ç„¡è³‡æ–™</div>
                        </div>
                    </div>
                </div>
                <!-- Top Item -->
                <div class="card bg-white p-4 rounded-3xl shadow-sm border border-berry text-center col-span-2">
                    <div class="flex items-center justify-center space-x-2">
                        <span class="text-xl">â¤ï¸</span>
                        <div class="text-left">
                            <div class="text-xs text-gray-400 font-bold uppercase">æœ€æ„›å“é …</div>
                            <div class="text-lg font-bold text-gray-800 truncate w-32 md:w-48" id="stat-top-item">ç„¡è³‡æ–™</div>
                        </div>
                    </div>
                </div>
                <!-- Avg Price -->
                <div class="col-span-2 bg-sky/30 p-2 rounded-xl text-center text-sm text-gray-600 font-medium">
                    å¹³å‡ä¸€æ¯å–®åƒ¹ï¼š<span id="stat-avg-price" class="text-gray-800 font-bold">$0</span>
                </div>
            </div>

            <!-- Input Form -->
            <div class="bg-white p-6 rounded-3xl shadow-md border-2 border-dashed border-tea">
                <h2 class="text-lg font-bold text-boba mb-4 flex items-center">
                    <span>âœï¸ ä»Šå¤©å–ä»€éº¼</span>
                </h2>
                <form id="drink-form" class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">æ—¥æœŸ</label>
                        <input type="date" id="input-date" required class="w-full bg-milk border border-tea rounded-xl px-4 py-2 focus:outline-none focus:ring-2 focus:ring-matcha transition-colors">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">åº—å®¶åç¨±</label>
                        <input type="text" id="input-shop" placeholder="ä¾‹å¦‚ï¼šäº”ååµ" required class="w-full bg-milk border border-tea rounded-xl px-4 py-2 focus:outline-none focus:ring-2 focus:ring-matcha transition-colors">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">é£²æ–™å“é …</label>
                        <input type="text" id="input-item" placeholder="ä¾‹å¦‚ï¼š1è™Ÿ (å››å­£æ˜¥+çæ³¢æ¤°)" required class="w-full bg-milk border border-tea rounded-xl px-4 py-2 focus:outline-none focus:ring-2 focus:ring-matcha transition-colors">
                    </div>
                    
                    <!-- ç³–åº¦èˆ‡å†°å¡Šé¸é … -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">ç³–åº¦</label>
                            <select id="input-sugar" class="w-full bg-milk border border-tea rounded-xl px-4 py-2 focus:outline-none focus:ring-2 focus:ring-matcha transition-colors appearance-none cursor-pointer">
                                <option value="å…¨ç³–">å…¨ç³–</option>
                                <option value="å°‘ç³–">å°‘ç³–</option>
                                <option value="åŠç³–">åŠç³–</option>
                                <option value="å¾®ç³–" selected>å¾®ç³–</option>
                                <option value="ä¸€åˆ†">ä¸€åˆ†</option>
                                <option value="ç„¡ç³–">ç„¡ç³–</option>
                                <option value="å›ºå®š">å›ºå®š</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">å†°å¡Š</label>
                            <select id="input-ice" class="w-full bg-milk border border-tea rounded-xl px-4 py-2 focus:outline-none focus:ring-2 focus:ring-matcha transition-colors appearance-none cursor-pointer">
                                <option value="æ­£å¸¸">æ­£å¸¸</option>
                                <option value="å°‘å†°" selected>å°‘å†°</option>
                                <option value="å¾®å†°">å¾®å†°</option>
                                <option value="å»å†°">å»å†°</option>
                                <option value="å¸¸æº«">å¸¸æº«</option>
                                <option value="æº«">æº«</option>
                                <option value="å›ºå®š">å›ºå®š</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">åƒ¹æ ¼</label>
                        <input type="number" id="input-price" placeholder="50" min="0" required class="w-full bg-milk border border-tea rounded-xl px-4 py-2 focus:outline-none focus:ring-2 focus:ring-matcha transition-colors">
                    </div>
                    <button type="submit" class="w-full bg-boba text-white font-bold py-3 rounded-xl shadow-lg hover:bg-opacity-90 active:scale-95 transition-all flex justify-center items-center gap-2">
                        <span>â• å­˜æª” </span>
                    </button>
                </form>
            </div>
        </div>

        <!-- Right Column: Charts & History -->
        <div class="lg:col-span-2 space-y-6">
            
            <!-- Charts Section -->
            <div class="bg-white p-6 rounded-3xl shadow-sm border border-gray-100">
                <h2 class="text-lg font-bold text-boba mb-4">ğŸ“Š æ•¸æ“šåˆ†æ</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Pie Chart -->
                    <div class="flex flex-col items-center">
                        <h3 class="text-sm font-bold text-gray-400 mb-2">åº—å®¶å–œå¥½åˆ†ä½ˆ</h3>
                        <div class="relative w-full aspect-square max-h-48 md:max-h-64">
                            <canvas id="shopChart"></canvas>
                        </div>
                    </div>
                    <!-- Bar Chart -->
                    <div class="flex flex-col items-center">
                        <h3 class="text-sm font-bold text-gray-400 mb-2">èŠ±è²»æœ€é«˜å“é … Top 5</h3>
                        <div class="relative w-full h-48 md:h-64">
                            <canvas id="itemChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- History List -->
            <div class="bg-white p-6 rounded-3xl shadow-sm border border-gray-100 h-[500px] flex flex-col">
                <div class="flex justify-between items-center mb-4 flex-wrap gap-2">
                    <h2 class="text-lg font-bold text-boba">ğŸ“œ æ‰‹æ–é£²æ­·å²</h2>
                    
                    <!-- Data Actions -->
                    <div class="flex space-x-2">
                         <button onclick="exportData()" class="px-3 py-1 bg-tea text-boba text-xs font-bold rounded-lg hover:bg-matcha transition-colors">
                            â¬‡ï¸ åŒ¯å‡ºå‚™ä»½
                        </button>
                        <label class="px-3 py-1 bg-tea text-boba text-xs font-bold rounded-lg hover:bg-matcha transition-colors cursor-pointer">
                            â¬†ï¸ åŒ¯å…¥è³‡æ–™
                            <input type="file" id="import-file" accept=".json" class="hidden" onchange="importData(this)">
                        </label>
                    </div>
                </div>
                
                <div class="overflow-y-auto flex-1 pr-2">
                    <table class="w-full text-left border-collapse">
                        <thead class="sticky top-0 bg-white">
                            <tr>
                                <th class="text-xs font-bold text-gray-400 py-2 border-b border-gray-100">æ—¥æœŸ</th>
                                <th class="text-xs font-bold text-gray-400 py-2 border-b border-gray-100">åº—å®¶</th>
                                <th class="text-xs font-bold text-gray-400 py-2 border-b border-gray-100">å“é …</th>
                                <th class="text-xs font-bold text-gray-400 py-2 border-b border-gray-100 text-right">åƒ¹æ ¼</th>
                                <th class="text-xs font-bold text-gray-400 py-2 border-b border-gray-100 text-center">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="history-list" class="text-sm">
                            <tr><td colspan="5" class="text-center py-8 text-gray-400">è¼‰å…¥ä¸­...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer for Version Checking -->
    <footer class="mt-8 mb-4 text-center w-full">
        <p class="text-xs text-gray-400 font-bold">Boba Tracker v2.3</p>
    </footer>

    <!-- Custom Confirmation Modal -->
    <div id="delete-modal" class="modal hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-30 backdrop-blur-sm p-4">
        <div class="modal-content bg-white rounded-3xl shadow-2xl p-6 w-full max-w-sm text-center border-4 border-tea">
            <div class="text-4xl mb-4">ğŸ—‘ï¸</div>
            <h3 class="text-xl font-bold text-boba mb-2">ç¢ºå®šè¦åˆªé™¤å—ï¼Ÿ</h3>
            <p class="text-gray-500 mb-6 text-sm">é€™ç­†ç´€éŒ„å°‡æœƒæ¶ˆå¤±ï¼Œç„¡æ³•å¾©åŸå–”ï¼</p>
            <div class="flex space-x-3 justify-center">
                <button onclick="closeModal()" class="px-6 py-2 rounded-xl border-2 border-gray-200 font-bold text-gray-500 hover:bg-gray-50 transition-colors">
                    å†æƒ³æƒ³
                </button>
                <button onclick="confirmDelete()" class="px-6 py-2 rounded-xl bg-red-400 text-white font-bold hover:bg-red-500 shadow-lg transition-colors">
                    åˆªé™¤å®ƒ
                </button>
            </div>
        </div>
    </div>

    <!-- JavaScript Logic -->
    <script>
        // --- Data Management (Safe Load) ---
        let drinks = [];
        try {
            const loaded = JSON.parse(localStorage.getItem('bobaDrinks'));
            if (Array.isArray(loaded)) {
                drinks = loaded;
            } else if (loaded) {
                // å¦‚æœè®€åˆ°çš„è³‡æ–™ä¸æ˜¯é™£åˆ— (å¯èƒ½æå£)ï¼Œé‡ç½®ç‚ºç©ºé™£åˆ—
                console.warn("Data corruption detected. Resetting to empty array.");
                drinks = [];
            }
        } catch (e) {
            console.error("LocalStorage error:", e);
            drinks = [];
        }
        
        let pendingDeleteId = null; 
        
        const form = document.getElementById('drink-form');
        const historyList = document.getElementById('history-list');
        const dateInput = document.getElementById('input-date');
        const deleteModal = document.getElementById('delete-modal');

        // Chart instances
        let shopChartInstance = null;
        let itemChartInstance = null;

        // Set default date to today (Local Time Fix)
        function setToday() {
            const d = new Date();
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            dateInput.value = `${year}-${month}-${day}`;
        }
        setToday();

        // Save to LocalStorage
        function saveData() {
            try {
                localStorage.setItem('bobaDrinks', JSON.stringify(drinks));
                renderApp();
            } catch (e) {
                alert("å„²å­˜å¤±æ•—ï¼å¯èƒ½æ˜¯æ‰‹æ©Ÿå„²å­˜ç©ºé–“å·²æ»¿ï¼Œæˆ–æ˜¯åœ¨ç§å¯†ç€è¦½æ¨¡å¼ã€‚\n" + e.message);
            }
        }

        // Add Drink (Robust Handler)
        form.addEventListener('submit', (e) => {
            e.preventDefault(); // Stop page reload
            
            try {
                const priceVal = document.getElementById('input-price').value;
                if (!priceVal || isNaN(parseInt(priceVal))) {
                    alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„åƒ¹æ ¼æ•¸å­—ï¼");
                    return;
                }

                const newDrink = {
                    id: Date.now(),
                    date: document.getElementById('input-date').value,
                    shop: document.getElementById('input-shop').value.trim(),
                    item: document.getElementById('input-item').value.trim(),
                    sugar: document.getElementById('input-sugar').value,
                    ice: document.getElementById('input-ice').value,
                    price: parseInt(priceVal),
                };
                
                drinks.unshift(newDrink);
                saveData();
                
                // UX: Restore options
                const currentSugar = document.getElementById('input-sugar').value; 
                const currentIce = document.getElementById('input-ice').value;
                
                form.reset();
                setToday();
                
                document.getElementById('input-sugar').value = currentSugar;
                document.getElementById('input-ice').value = currentIce;
                
            } catch (err) {
                alert("ç™¼ç”Ÿæœªé æœŸçš„éŒ¯èª¤ï¼Œè«‹æˆªåœ–çµ¦é–‹ç™¼è€…ï¼š\n" + err.message);
                console.error(err);
            }
        });

        // --- Modal & Delete Logic ---

        window.openDeleteModal = function(id) {
            pendingDeleteId = id;
            deleteModal.classList.remove('hidden');
        };

        window.closeModal = function() {
            pendingDeleteId = null;
            deleteModal.classList.add('hidden');
        };

        window.confirmDelete = function() {
            if (pendingDeleteId) {
                drinks = drinks.filter(d => d.id !== pendingDeleteId);
                saveData();
                closeModal();
            }
        };

        deleteModal.addEventListener('click', (e) => {
            if (e.target === deleteModal) {
                closeModal();
            }
        });

        // Clear All logic
        window.clearAllData = function() {
            if(confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰è³‡æ–™å—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸï¼')) {
                drinks = [];
                saveData();
            }
        };

        // --- Export / Import Functions ---
        
        window.exportData = function() {
            if (drinks.length === 0) {
                alert("ç›®å‰æ²’æœ‰è³‡æ–™å¯ä»¥åŒ¯å‡ºå–”ï¼");
                return;
            }
            const dataStr = JSON.stringify(drinks, null, 2);
            const blob = new Blob([dataStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `æ‰‹æ–é£²ç´€éŒ„å‚™ä»½_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        };

        window.importData = function(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedDrinks = JSON.parse(e.target.result);
                    if (Array.isArray(importedDrinks)) {
                        if(confirm(`æº–å‚™åŒ¯å…¥ ${importedDrinks.length} ç­†è³‡æ–™ã€‚\né€™å°‡æœƒè¦†è“‹ç›®å‰çš„è³‡æ–™ï¼Œç¢ºå®šå—ï¼Ÿ`)) {
                            drinks = importedDrinks;
                            saveData();
                            alert("è³‡æ–™åŒ¯å…¥æˆåŠŸï¼ğŸ‰");
                        }
                    } else {
                        alert("æª”æ¡ˆæ ¼å¼éŒ¯èª¤ï¼Œè«‹ç¢ºèªé€™æ˜¯æ­£ç¢ºçš„å‚™ä»½æª”ã€‚");
                    }
                } catch (error) {
                    alert("è®€å–æª”æ¡ˆå¤±æ•—ï¼š" + error);
                }
                input.value = '';
            };
            reader.readAsText(file);
        };

        // --- Rendering Logic ---

        function renderApp() {
            try {
                renderHistory();
                renderStats();
                // Check if Chart is loaded
                if (typeof Chart !== 'undefined') {
                    renderCharts();
                } else {
                    console.warn("Chart.js failed to load. Skipping charts.");
                }
            } catch (e) {
                console.error("Render Error:", e);
            }
        }

        function renderHistory() {
            historyList.innerHTML = '';
            
            if (drinks.length === 0) {
                historyList.innerHTML = `<tr><td colspan="5" class="text-center py-8 text-gray-400">ç›®å‰æ²’æœ‰ç´€éŒ„ï¼Œå¿«å»è²·ä¸€æ¯å§ï¼ ğŸ¥¤</td></tr>`;
                return;
            }

            drinks.forEach(drink => {
                const details = [drink.sugar, drink.ice].filter(Boolean).join(' / ');

                const row = document.createElement('tr');
                row.className = "hover:bg-milk/50 transition-colors border-b border-gray-50";
                row.innerHTML = `
                    <td class="py-3 text-gray-500 whitespace-nowrap">${drink.date}</td>
                    <td class="py-3 font-medium text-boba">${drink.shop}</td>
                    <td class="py-3 text-gray-600">
                        <div>${drink.item}</div>
                        <div class="text-xs text-gray-400">${details}</div>
                    </td>
                    <td class="py-3 font-bold text-gray-700 text-right">$${drink.price}</td>
                    <td class="py-3 text-center">
                        <button onclick="openDeleteModal(${drink.id})" class="text-gray-300 hover:text-red-500 transition-colors p-1 text-lg">
                            ğŸ—‘ï¸
                        </button>
                    </td>
                `;
                historyList.appendChild(row);
            });
        }

        function renderStats() {
            const totalCups = drinks.length;
            const totalSpent = drinks.reduce((acc, curr) => acc + (curr.price || 0), 0);
            const avgPrice = totalCups > 0 ? Math.round(totalSpent / totalCups) : 0;

            const shopCount = {};
            drinks.forEach(d => { shopCount[d.shop] = (shopCount[d.shop] || 0) + 1; });
            const topShop = Object.keys(shopCount).length > 0 
                ? Object.keys(shopCount).reduce((a, b) => shopCount[a] > shopCount[b] ? a : b)
                : "ç„¡è³‡æ–™";

            const itemCount = {};
            drinks.forEach(d => { itemCount[d.item] = (itemCount[d.item] || 0) + 1; });
            const topItem = Object.keys(itemCount).length > 0 
                ? Object.keys(itemCount).reduce((a, b) => itemCount[a] > itemCount[b] ? a : b)
                : "ç„¡è³‡æ–™";

            document.getElementById('stat-total-cups').textContent = totalCups;
            document.getElementById('stat-total-spent').textContent = '$' + totalSpent.toLocaleString();
            document.getElementById('stat-avg-price').textContent = '$' + avgPrice;
            document.getElementById('stat-top-shop').textContent = topShop;
            document.getElementById('stat-top-item').textContent = topItem;
        }

        function renderCharts() {
            if (drinks.length === 0) {
                if(shopChartInstance) shopChartInstance.destroy();
                if(itemChartInstance) itemChartInstance.destroy();
                return;
            }

            // 1. Data for Shop Pie Chart
            const shopCount = {};
            drinks.forEach(d => { shopCount[d.shop] = (shopCount[d.shop] || 0) + 1; });
            const sortedShops = Object.entries(shopCount).sort((a,b) => b[1] - a[1]);
            const shopLabels = sortedShops.map(s => s[0]);
            const shopData = sortedShops.map(s => s[1]);

            const ctxShop = document.getElementById('shopChart').getContext('2d');
            
            if(shopChartInstance) shopChartInstance.destroy();

            shopChartInstance = new Chart(ctxShop, {
                type: 'doughnut',
                data: {
                    labels: shopLabels,
                    datasets: [{
                        data: shopData,
                        backgroundColor: [
                            '#E6C9A8', '#C8D5B9', '#F4ACB7', '#D7E3FC', '#FFD6A5', '#B9FBC0'
                        ],
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { boxWidth: 10, font: {family: "'Zen Maru Gothic'"} } }
                    }
                }
            });

            // 2. Data for Top Items (by spending)
            const itemSpending = {};
            drinks.forEach(d => { itemSpending[d.item] = (itemSpending[d.item] || 0) + (d.price || 0); });
            const sortedItems = Object.entries(itemSpending).sort((a,b) => b[1] - a[1]).slice(0, 5); 
            
            const itemLabels = sortedItems.map(i => i[0]);
            const itemData = sortedItems.map(i => i[1]);

            const ctxItem = document.getElementById('itemChart').getContext('2d');
            
            if(itemChartInstance) itemChartInstance.destroy();

            itemChartInstance = new Chart(ctxItem, {
                type: 'bar',
                data: {
                    labels: itemLabels,
                    datasets: [{
                        label: 'ç´¯è¨ˆèŠ±è²» ($)',
                        data: itemData,
                        backgroundColor: '#5C4033',
                        borderRadius: 8,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y', 
                    scales: {
                        x: { beginAtZero: true, grid: { display: false } },
                        y: { grid: { display: false }, ticks: { font: {family: "'Zen Maru Gothic'"} } }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }

        // Initialize
        renderApp();

    </script>
</body>
</html>
